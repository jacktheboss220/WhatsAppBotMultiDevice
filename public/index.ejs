<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Eva - WhatsApp Bot</title>
		<link rel="stylesheet" href="/style.css" />
		<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
	</head>
	<body>
		<div class="container">
			<!-- Header Section -->
			<header class="header">
				<div class="logo">
					<h1>ü§ñ Eva Bot</h1>
					<p class="tagline">Your Ultimate WhatsApp Assistant</p>
				</div>
			</header>

			<!-- Connection Status Section -->
			<section class="connection-section">
				<h2>Bot Status</h2>
				<div id="qrcode" class="qr-container">
					<div class="loading">
						<div class="spinner"></div>
						<p>Initializing...</p>
					</div>
				</div>
			</section>

			<!-- Send Message Section -->
			<section class="message-section">
				<h2>Send a Test Message</h2>
				<form id="sendForm">
					<div class="form-group">
						<input type="text" id="to" placeholder="Recipient number (e.g., 1234567890)" required />
					</div>
					<div class="form-group">
						<input type="text" id="message" placeholder="Your message" required />
					</div>
					<button type="submit" class="btn-primary">Send Message</button>
				</form>
				<div id="status" class="status-message"></div>
			</section>

			<!-- Commands Section -->
			<section class="commands-section">
				<h2>üìã Available Commands</h2>
				<div id="commands-container">
					<div class="loading-commands">
						<div class="spinner"></div>
						<p>Loading commands...</p>
					</div>
				</div>
			</section>

			<!-- Footer -->
			<footer class="footer">
				<p>
					Made with ‚ù§Ô∏è by
					<a href="http://github.com/jacktheboss220">jacktheboss220</a>
				</p>
				<p class="footer-links">
					<a href="https://github.com/jacktheboss220/WhatsAppBotMultiDevice" target="_blank">GitHub</a>
				</p>
			</footer>
		</div>

		<script>
			const socket = new WebSocket((location.protocol === "https:" ? "wss://" : "ws://") + window.location.host);

			// HTML escape function to prevent XSS and display issues
			function escapeHtml(text) {
				const map = {
					"&": "&amp;",
					"<": "&lt;",
					">": "&gt;",
					'"': "&quot;",
					"'": "&#039;",
					"`": "&#96;",
				};
				return text.replace(/[&<>"'`]/g, (m) => map[m]);
			}

			// Fetch and display commands
			async function loadCommands() {
				try {
					const response = await fetch("/api/commands");
					const data = await response.json();
					displayCommands(data);
				} catch (error) {
					console.error("Error loading commands:", error);
					document.getElementById("commands-container").innerHTML = `
						<div class="error-message">
							<p>‚ùå Failed to load commands</p>
						</div>
					`;
				}
			}

			function displayCommands(data) {
				const container = document.getElementById("commands-container");
				let html = "";

				// Public Commands
				if (data.publicCommands && data.publicCommands.length > 0) {
					html += `
						<div class="command-category">
							<h3 class="category-title">üë• Public Commands</h3>
							<div class="commands-grid">
								${data.publicCommands
									.map(
										(cmd) => `
									<div class="command-card">
										<code class="command-name">${escapeHtml(cmd.cmd.join(", "))}</code>
										<p class="command-desc">${escapeHtml(cmd.desc || "No description")}</p>
										<p class="command-usage">Usage: <code>${escapeHtml(cmd.usage || cmd.cmd[0])}</code></p>
									</div>
								`
									)
									.join("")}
							</div>
						</div>
					`;
				}

				// Group Commands
				if (data.groupCommands && data.groupCommands.length > 0) {
					html += `
						<div class="command-category">
							<h3 class="category-title">üë´ Group Commands</h3>
							<div class="commands-grid">
								${data.groupCommands
									.map(
										(cmd) => `
									<div class="command-card group">
										<code class="command-name">${escapeHtml(cmd.cmd.join(", "))}</code>
										<p class="command-desc">${escapeHtml(cmd.desc || "No description")}</p>
										<p class="command-usage">Usage: <code>${escapeHtml(cmd.usage || cmd.cmd[0])}</code></p>
									</div>
								`
									)
									.join("")}
							</div>
						</div>
					`;
				}

				// Admin Commands
				if (data.adminCommands && data.adminCommands.length > 0) {
					html += `
						<div class="command-category">
							<h3 class="category-title">üëë Admin Commands</h3>
							<div class="commands-grid">
								${data.adminCommands
									.map(
										(cmd) => `
									<div class="command-card admin">
										<code class="command-name">${escapeHtml(cmd.cmd.join(", "))}</code>
										<p class="command-desc">${escapeHtml(cmd.desc || "No description")}</p>
										<p class="command-usage">Usage: <code>${escapeHtml(cmd.usage || cmd.cmd[0])}</code></p>
									</div>
								`
									)
									.join("")}
							</div>
						</div>
					`;
				}

				// Owner Commands
				if (data.ownerCommands && data.ownerCommands.length > 0) {
					html += `
						<div class="command-category">
							<h3 class="category-title">üë®‚Äçüíº Owner Commands</h3>
							<div class="commands-grid">
								${data.ownerCommands
									.map(
										(cmd) => `
									<div class="command-card owner">
										<code class="command-name">${escapeHtml(cmd.cmd.join(", "))}</code>
										<p class="command-desc">${escapeHtml(cmd.desc || "No description")}</p>
										<p class="command-usage">Usage: <code>${escapeHtml(cmd.usage || cmd.cmd[0])}</code></p>
									</div>
								`
									)
									.join("")}
							</div>
						</div>
					`;
				}

				container.innerHTML = html;
			}

			// Load commands on page load
			loadCommands();

			socket.onmessage = function (event) {
				const qrCodeDiv = document.getElementById("qrcode");
				const qrString = event.data;

				try {
					const parsedData = JSON.parse(qrString);
					if (parsedData.type === "qr") {
						QRCode.toDataURL(parsedData.qr, function (err, url) {
							if (err) {
								console.error("QR Code generation failed", err);
								qrCodeDiv.innerHTML = '<div class="error"><p>‚ùå QR Code generation failed</p></div>';
								return;
							}
							qrCodeDiv.innerHTML = `
								<div class="qr-box">
									<p class="qr-instruction">Scan this QR code with WhatsApp</p>
									<img src="${url}" alt="QR Code" />
									<p class="qr-hint">Open WhatsApp ‚Üí Settings ‚Üí Linked Devices ‚Üí Link a Device</p>
								</div>
							`;
						});
					} else if (parsedData.type === "status" && parsedData.status === "connected") {
						qrCodeDiv.innerHTML = `
							<div class="status-box connected">
								<div class="status-icon">‚úÖ</div>
								<h3>Bot is Running!</h3>
								<p>Successfully connected to WhatsApp</p>
							</div>
						`;
					} else if (parsedData.type === "success") {
						qrCodeDiv.innerHTML = `
							<div class="status-box connected">
								<div class="status-icon">‚úÖ</div>
								<p>${parsedData.success}</p>
							</div>
						`;
					}
				} catch (err) {
					console.error("Error parsing WebSocket message:", err);
				}
			};

			socket.onerror = function (error) {
				const qrCodeDiv = document.getElementById("qrcode");
				qrCodeDiv.innerHTML = `
					<div class="status-box error">
						<div class="status-icon">‚ö†Ô∏è</div>
						<h3>Connection Error</h3>
						<p>Unable to connect to the bot server</p>
					</div>
				`;
			};

			const form = document.getElementById("sendForm");
			form.addEventListener("submit", (e) => {
				e.preventDefault();
				const to = document.getElementById("to").value;
				const message = document.getElementById("message").value;
				const statusDiv = document.getElementById("status");

				if (socket.readyState === WebSocket.OPEN) {
					socket.send(JSON.stringify({ to, message }));
					statusDiv.className = "status-message success";
					statusDiv.textContent = "‚úÖ Message sent successfully!";
					form.reset();
				} else {
					statusDiv.className = "status-message error";
					statusDiv.textContent = "‚ùå WebSocket connection not open. Please wait for the bot to connect.";
				}
			});
		</script>
	</body>
</html>
